name: Vulnerability and Dependency Automation

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Vulnerability action'
        required: true
        type: choice
        options:
          - scan
          - create_fix_pr
          - review_alerts
  schedule:
    # Run security scan weekly
    - cron: '0 0 * * 0'
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: write

jobs:
  security-scan:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && inputs.action == 'scan')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit

      - name: Run safety check
        id: safety
        continue-on-error: true
        run: |
          safety check --json > safety-report.json || true
          if [ -s safety-report.json ]; then
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
          fi

      - name: Run pip-audit
        id: pip-audit
        continue-on-error: true
        run: |
          pip-audit --format json > pip-audit-report.json || true
          if [ -s pip-audit-report.json ]; then
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload security reports
        if: steps.safety.outputs.has_vulnerabilities == 'true' || steps.pip-audit.outputs.has_vulnerabilities == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            safety-report.json
            pip-audit-report.json

      - name: Create issue for vulnerabilities
        if: steps.safety.outputs.has_vulnerabilities == 'true' || steps.pip-audit.outputs.has_vulnerabilities == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let vulnerabilities = [];
            
            // Parse safety report
            if (fs.existsSync('safety-report.json')) {
              const safetyData = JSON.parse(fs.readFileSync('safety-report.json', 'utf8'));
              vulnerabilities.push('## Safety Check Results\n');
              vulnerabilities.push(JSON.stringify(safetyData, null, 2));
            }
            
            // Parse pip-audit report
            if (fs.existsSync('pip-audit-report.json')) {
              const auditData = JSON.parse(fs.readFileSync('pip-audit-report.json', 'utf8'));
              vulnerabilities.push('\n## Pip Audit Results\n');
              vulnerabilities.push(JSON.stringify(auditData, null, 2));
            }
            
            if (vulnerabilities.length > 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”’ Security vulnerabilities detected - ${new Date().toISOString().split('T')[0]}`,
                body: `Security scan has detected vulnerabilities in dependencies.\n\n${vulnerabilities.join('\n')}`,
                labels: ['security', 'dependencies', 'automated']
              });
            }

  auto-fix-vulnerabilities:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'create_fix_pr'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools pip-audit

      - name: Attempt to fix vulnerabilities
        id: fix
        run: |
          # Create a backup of current requirements
          cp pyproject.toml pyproject.toml.bak
          
          # Try to upgrade vulnerable packages
          pip-audit --fix --dry-run > fix-plan.txt || true
          
          if [ -s fix-plan.txt ]; then
            echo "has_fixes=true" >> $GITHUB_OUTPUT
            echo "Fix plan generated"
          else
            echo "has_fixes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create PR with fixes
        if: steps.fix.outputs.has_fixes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix: update dependencies to fix security vulnerabilities'
          title: 'ðŸ”’ Security: Update dependencies to fix vulnerabilities'
          body: |
            ## Security Update
            
            This PR automatically updates dependencies to fix known security vulnerabilities.
            
            ### Changes
            - Updates vulnerable packages to their latest secure versions
            - Generated by automated security scanning
            
            ### Testing Required
            Please ensure all tests pass before merging.
            
            ---
            *This PR was automatically generated by the vulnerability automation workflow.*
          branch: security/auto-fix-vulnerabilities
          labels: security,dependencies,automated
          reviewers: ${{ github.repository_owner }}

  review-dependabot-alerts:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'review_alerts'
    
    steps:
      - name: Get Dependabot alerts
        uses: actions/github-script@v7
        with:
          script: |
            const alerts = await github.rest.dependabot.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            if (alerts.data.length > 0) {
              let summary = '## Open Dependabot Alerts\n\n';
              
              for (const alert of alerts.data) {
                summary += `### ${alert.security_advisory.summary}\n`;
                summary += `- **Severity**: ${alert.security_advisory.severity}\n`;
                summary += `- **Package**: ${alert.security_vulnerability.package.name}\n`;
                summary += `- **Vulnerable versions**: ${alert.security_vulnerability.vulnerable_version_range}\n`;
                summary += `- **Patched version**: ${alert.security_vulnerability.first_patched_version?.identifier || 'N/A'}\n`;
                summary += `- **URL**: ${alert.html_url}\n\n`;
              }
              
              console.log(summary);
              
              // Create or update issue
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'dependabot-summary',
                state: 'open'
              });
              
              if (issues.data.length > 0) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issues.data[0].number,
                  body: summary
                });
              } else {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ðŸ”’ Dependabot Alert Summary',
                  body: summary,
                  labels: ['security', 'dependabot-summary']
                });
              }
            }
